---
# roles/pxe-server/tasks/debootstrap.yml
# Fully bootstrap a PXE Debian image with updates, programs, and users
# Includes detailed comments for clarity

# ----------------------------
# Ensure working directories exist
# ----------------------------
- name: Ensure working directories exist
  file:
    path: "{{ item }}"
    state: directory
  loop:
    - /srv/live-build/work       # temporary work directory for debootstrap operations
    - /srv/live-build/pxe-root   # target root filesystem for PXE boot

# ----------------------------
# Bootstrap minimal Debian system
# ----------------------------
- name: Bootstrap minimal Debian system
  command: >
    debootstrap --arch=amd64 bookworm /srv/live-build/pxe-root http://deb.debian.org/debian
  args:
    creates: /srv/live-build/pxe-root/bin/bash  # skip if already bootstrapped

# ----------------------------
# Prepare essential virtual filesystems in PXE root
# ----------------------------
- name: Ensure /proc, /sys, /dev, /dev/pts exist in PXE root
  file:
    path: "{{ item }}"
    state: directory
  loop:
    - /srv/live-build/pxe-root/proc
    - /srv/live-build/pxe-root/sys
    - /srv/live-build/pxe-root/dev
    - /srv/live-build/pxe-root/dev/pts

- name: Mount /proc inside PXE root
  mount:
    path: /srv/live-build/pxe-root/proc
    src: proc
    fstype: proc
    state: mounted

- name: Mount /sys inside PXE root
  mount:
    path: /srv/live-build/pxe-root/sys
    src: sysfs
    fstype: sysfs
    state: mounted

- name: Bind-mount /dev inside PXE root
  mount:
    path: /srv/live-build/pxe-root/dev
    src: /dev
    fstype: none
    opts: bind
    state: mounted

- name: Bind-mount /dev/pts inside PXE root
  mount:
    path: /srv/live-build/pxe-root/dev/pts
    src: /dev/pts
    fstype: none
    opts: bind
    state: mounted

# ----------------------------
# Update system inside chroot
# ----------------------------
- name: Update apt and upgrade inside PXE image
  command: chroot /srv/live-build/pxe-root /bin/bash -c "apt-get update && DEBIAN_FRONTEND=noninteractive apt-get -y upgrade"

# ----------------------------
# Install essential Linux tools
# ----------------------------
- name: Install essential Linux tools
  command: chroot /srv/live-build/pxe-root /bin/bash -c "DEBIAN_FRONTEND=noninteractive apt-get -y install sudo vim curl wget net-tools htop tree"

# ----------------------------
# Create users inside PXE image (idempotent)
# ----------------------------
- name: Create users without passwords if not exists
  vars:
    users_no_pass:
      - blackpianocat
      - whitesexyorca
  loop: "{{ users_no_pass }}"
  loop_control:
    loop_var: user
  command: >
    chroot /srv/live-build/pxe-root /bin/bash -c
    "id -u {{ user }} || useradd -m -s /bin/bash {{ user }}"

- name: Create users with predefined passwords if not exists
  vars:
    users_passwords:
      - { name: "whitesmellyracoon", password: "racoonsfart" }
      - { name: "admin", password: "admin_rocks" }
  loop: "{{ users_passwords }}"
  loop_control:
    loop_var: user
  command: >
    chroot /srv/live-build/pxe-root /bin/bash -c
    "id -u {{ user.name }} || (useradd -m -s /bin/bash {{ user.name }} && echo '{{ user.name }}:{{ user.password }}' | chpasswd)"

- name: Create user redhandsomegorilla forcing password change on first login if not exists
  command: >
    chroot /srv/live-build/pxe-root /bin/bash -c
    "id -u redhandsomegorilla || (useradd -m -s /bin/bash redhandsomegorilla && passwd -d redhandsomegorilla && chage -d 0 redhandsomegorilla)"

# ----------------------------
# Configure sudoers
# ----------------------------
- name: Configure sudoers for admin and blackpianocat
  block:
    - copy:
        dest: /srv/live-build/pxe-root/etc/sudoers.d/admin
        mode: '0440'
        content: |
          admin ALL=(ALL) ALL
    - copy:
        dest: /srv/live-build/pxe-root/etc/sudoers.d/blackpianocat
        mode: '0440'
        content: |
          blackpianocat ALL=(ALL) NOPASSWD: ALL

# ----------------------------
# Clean up apt cache inside chroot
# ----------------------------
- name: Clean apt cache inside PXE image
  command: chroot /srv/live-build/pxe-root /bin/bash -c "apt-get clean"

# ----------------------------
# Unmount virtual filesystems after setup
# ----------------------------
- name: Unmount virtual filesystems
  block:
    - command: umount /srv/live-build/pxe-root/proc
      ignore_errors: yes
    - command: umount /srv/live-build/pxe-root/sys
      ignore_errors: yes
    - command: umount /srv/live-build/pxe-root/dev/pts
      ignore_errors: yes
    - command: umount /srv/live-build/pxe-root/dev
      ignore_errors: yes

# ----------------------------
# Install kernel inside chroot
# ----------------------------
- name: Install kernel inside chroot
  command: >
    chroot /srv/live-build/pxe-root /bin/bash -c
    "DEBIAN_FRONTEND=noninteractive apt-get -y install linux-image-amd64"

# ----------------------------
# Copy kernel and initrd to TFTP directory
# ----------------------------
- name: Copy kernel to TFTP
  shell: |
    cp /srv/live-build/pxe-root/boot/vmlinuz-* /srv/tftp/vmlinuz
  args:
    executable: /bin/bash

- name: Copy initrd to TFTP
  shell: |
    cp /srv/live-build/pxe-root/boot/initrd.img-* /srv/tftp/initrd.img
  args:
    executable: /bin/bash

# ----------------------------
# Configure NFS export for PXE root
# ----------------------------
- name: Ensure /etc/exports.d exists
  file:
    path: /etc/exports.d
    state: directory
    mode: '0755'

- name: Configure NFS export for PXE root
  copy:
    dest: /etc/exports.d/pxe-root.exports
    mode: '0644'
    content: |
      /srv/live-build/pxe-root {{ pxe_ip.stdout }}/24(rw,no_root_squash,no_subtree_check)
      # use PXE interface IP to allow clients on correct subnet to mount

- name: Reload NFS exports
  command: exportfs -ra
  # ensures NFS exports are active and visible to clients

# ----------------------------
# Include NFS and network modules in initrd
# ----------------------------
- name: Ensure NFS and network modules included in initrd
  command: >
    chroot /srv/live-build/pxe-root /bin/bash -c
    "echo 'nfs nfsd nfsv3 nfsv4 ext4 inet' >> /etc/initramfs-tools/modules && update-initramfs -u -k all"
  # necessary for PXE boot with NFS root

# ----------------------------
# PXE menu entry for bootstrapped Debian
# ----------------------------
- name: Create PXE boot menu entry for bootstrapped Debian
  copy:
    dest: /srv/tftp/pxelinux.cfg/default
    mode: '0644'
    content: |
      DEFAULT debianpxe
      PROMPT 0
      TIMEOUT 50

      LABEL debianpxe
        MENU LABEL Debian PXE boot (debootstrap)
        KERNEL vmlinuz
        INITRD initrd.img
        APPEND root=/dev/nfs nfsroot={{ pxe_ip.stdout }}:/srv/live-build/pxe-root,rw ip=dhcp
        # PXE client mounts the NFS root from correct PXE interface IP


---
# PXE Debian boot using debootstrap and NFS root
# Compatible with dnsmasq TFTP setup from setup.yml

# ----------------------------
# Detect PXE interface IP
# ----------------------------
- name: Detect PXE interface IP
  shell: "ip -4 addr show dev {{ pxe_interface | default('eth1') }} | grep -oP '(?<=inet\\s)\\d+(\\.\\d+){3}'"
  register: pxe_ip
  changed_when: false
  failed_when: pxe_ip.stdout == ""

- debug:
    msg: "PXE server IP: '{{ pxe_ip.stdout }}'"

# ----------------------------
# Ensure host has internet
# ----------------------------
- name: Ensure DNS resolver is present
  lineinfile:
    path: /etc/resolv.conf
    line: "nameserver 8.8.8.8"
    state: present
    create: yes

- name: Wait until deb.debian.org is reachable
  wait_for:
    host: deb.debian.org
    port: 80
    timeout: 60

# ----------------------------
# Create directories for PXE root
# ----------------------------
- name: Create directories for PXE root
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /srv/live-build/pxe-root

# ----------------------------
# Bootstrap minimal Debian
# ----------------------------
- name: Bootstrap Debian base system
  command: >
    debootstrap --arch=amd64 bookworm /srv/live-build/pxe-root http://deb.debian.org/debian
  args:
    creates: /srv/live-build/pxe-root/bin/bash

# ----------------------------
# Copy resolv.conf and create sources.list
# ----------------------------
- name: Copy resolv.conf into chroot
  copy:
    src: /etc/resolv.conf
    dest: /srv/live-build/pxe-root/etc/resolv.conf

- name: Create minimal sources.list in chroot
  copy:
    dest: /srv/live-build/pxe-root/etc/apt/sources.list
    mode: '0644'
    content: |
      deb http://deb.debian.org/debian bookworm main contrib non-free
      deb http://deb.debian.org/debian bookworm-updates main contrib non-free
      deb http://security.debian.org/debian-security bookworm-security main contrib non-free

# ----------------------------
# Bind /tmp for apt inside chroot
# ----------------------------
- name: Bind /tmp inside chroot
  mount:
    path: /srv/live-build/pxe-root/tmp
    src: /tmp
    fstype: none
    opts: bind
    state: mounted

# ----------------------------
# Mount virtual filesystems inside chroot
# ----------------------------
- name: Mount virtual filesystems
  block:
    - mount: { path: /srv/live-build/pxe-root/proc, src: proc, fstype: proc, state: mounted }
    - mount: { path: /srv/live-build/pxe-root/sys, src: sysfs, fstype: sysfs, state: mounted }
    - mount: { path: /srv/live-build/pxe-root/dev, src: /dev, fstype: none, opts: bind, state: mounted }
    - mount: { path: /srv/live-build/pxe-root/dev/pts, src: /dev/pts, fstype: none, opts: bind, state: mounted }

# ----------------------------
# Update package list inside chroot
# ----------------------------
- name: Update APT inside chroot
  command: chroot /srv/live-build/pxe-root /bin/bash -c "apt-get update"

# ----------------------------
# Install essential PXE packages inside chroot (without tftpd-hpa)
# ----------------------------
- name: Install essential PXE packages inside chroot
  command: chroot /srv/live-build/pxe-root /bin/bash -c \
    "DEBIAN_FRONTEND=noninteractive apt-get install -y initramfs-tools linux-image-amd64 nfs-common iproute2 net-tools sudo vim curl wget syslinux-common pxelinux"

# ----------------------------
# Clean apt cache inside chroot
# ----------------------------
- name: Clean apt cache inside chroot
  command: chroot /srv/live-build/pxe-root /bin/bash -c "apt-get clean"

# ----------------------------
# Create admin and standard users
# ----------------------------
- name: Ensure admin user blackpianocat exists
  command: >
    chroot /srv/live-build/pxe-root /bin/bash -c
    "id -u blackpianocat >/dev/null 2>&1 || \
     (useradd -m -s /bin/bash blackpianocat && \
      echo 'blackpianocat:sebix4ever' | chpasswd && \
      usermod -aG sudo blackpianocat)"

- name: Ensure standard users exist
  loop:
    - kotek-1
    - kotek-2
  command: >
    chroot /srv/live-build/pxe-root /bin/bash -c
    "id -u {{ item }} >/dev/null 2>&1 || useradd -m -s /bin/bash {{ item }}"

# ----------------------------
# Configure sudoers
# ----------------------------
- name: Give admin passwordless sudo
  copy:
    dest: /srv/live-build/pxe-root/etc/sudoers.d/blackpianocat
    mode: '0440'
    content: |
      blackpianocat ALL=(ALL) NOPASSWD: ALL

# ----------------------------
# Add NFS support to initramfs
# ----------------------------
- name: Add NFS support to initramfs
  command: >
    chroot /srv/live-build/pxe-root /bin/bash -c
    "echo -e 'nfs\nnfsv3\nnfsv4\next4' >> /etc/initramfs-tools/modules && update-initramfs -u -k all"

# ----------------------------
# Copy kernel/initrd to TFTP for PXE
# ----------------------------
- name: Copy kernel and initrd images to TFTP
  shell: |
    cp /srv/live-build/pxe-root/boot/vmlinuz-* /srv/tftp/vmlinuz
    cp /srv/live-build/pxe-root/boot/initrd.img-* /srv/tftp/initrd.img
  args:
    executable: /bin/bash

- name: Make TFTP files world-readable
  file:
    path: "{{ item }}"
    mode: '0644'
  loop:
    - /srv/tftp/vmlinuz
    - /srv/tftp/initrd.img

# ----------------------------
# Configure PXE boot menu for NFS root
# ----------------------------
- name: Configure PXE menu
  copy:
    dest: /srv/tftp/pxelinux.cfg/default
    mode: '0644'
    content: |
      DEFAULT debian
      PROMPT 0
      TIMEOUT 50

      LABEL debian
        MENU LABEL Boot Debian PXE
        KERNEL vmlinuz
        INITRD initrd.img
        APPEND root=/dev/nfs nfsroot={{ pxe_ip.stdout }}:/srv/live-build/pxe-root,rw ip=dhcp

# ----------------------------
# Export PXE root via NFS
# ----------------------------
- name: Ensure /etc/exports.d exists
  file:
    path: /etc/exports.d
    state: directory
    mode: '0755'

# Then configure the NFS export
- name: Configure NFS export
  copy:
    dest: /etc/exports.d/pxe-root.exports
    mode: '0644'
    content: "/srv/live-build/pxe-root {{ pxe_ip.stdout }}/24(rw,no_root_squash,no_subtree_check)"

- name: Reload NFS exports
  command: exportfs -ra

- name: Ensure NFS server is running
  service:
    name: nfs-kernel-server
    state: started
    enabled: yes

# ----------------------------
# Unmount chroot filesystems
# ----------------------------
- name: Unmount virtual filesystems
  block:
    - shell: umount /srv/live-build/pxe-root/dev/pts || true
    - shell: umount /srv/live-build/pxe-root/dev || true
    - shell: umount /srv/live-build/pxe-root/sys || true
    - shell: umount /srv/live-build/pxe-root/proc || true
  ignore_errors: yes

- name: PXE boot image ready
  debug:
    msg: "PXE root is bootable. Clients can now boot via network."


---
# roles/pxe-server/tasks/network_setup.yml
# Configure network for PXE clients to have internet access and DHCP for PXE boot

# ----------------------------
# Detect PXE interface
# ----------------------------
- name: Detect PXE interface (host-only or internal)
  shell: ip -o -4 addr show | awk '/192\.168\.56\./ {print $2; exit}'
  register: iface_result
  changed_when: false
  failed_when: iface_result.rc != 0 or iface_result.stdout == ""

- name: Set PXE interface fact
  set_fact:
    pxe_interface: "{{ iface_result.stdout | trim | default('eth1') }}"

- name: Show PXE interface info
  debug:
    msg: "Using interface {{ pxe_interface }}"

# ----------------------------
# Enable IP forwarding
# ----------------------------
- name: Enable IP forwarding for routing
  sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    reload: yes
  # allows PXE clients to access the internet through the server

# ----------------------------
# Configure NAT for PXE clients
# ----------------------------
- name: Install iptables-persistent
  apt:
    name: iptables-persistent
    state: present
    update_cache: yes

- name: Set up NAT via iptables (MASQUERADE)
  shell: iptables -t nat -A POSTROUTING -o {{ ansible_default_ipv4.interface }} -j MASQUERADE

- name: Save iptables rules permanently
  shell: iptables-save > /etc/iptables/rules.v4

# ----------------------------
# Configure DHCP and PXE via dnsmasq
# ----------------------------
- name: Install dnsmasq if not present
  apt:
    name: dnsmasq
    state: present
    update_cache: yes

- name: Backup original dnsmasq config
  copy:
    src: /etc/dnsmasq.conf
    dest: /etc/dnsmasq.conf.bak
    remote_src: yes
    force: no

- name: Remove old PXE configs
  file:
    path: /etc/dnsmasq.d/pxe.conf
    state: absent

- name: Configure dnsmasq for PXE + DHCP
  copy:
    dest: /etc/dnsmasq.d/pxe.conf
    content: |
      interface={{ pxe_interface }}
      bind-interfaces
      dhcp-range=192.168.56.100,192.168.56.200,12h
      dhcp-boot=pxelinux.0
      enable-tftp
      tftp-root=/srv/tftp
      log-dhcp
      # Provides DHCP leases and TFTP access to PXE clients

- name: Restart dnsmasq
  systemd:
    name: dnsmasq
    state: restarted
    enabled: yes

# ----------------------------
# Test network access
# ----------------------------
- name: Ensure server can ping upstream DNS
  ansible.builtin.shell: ping -c 3 8.8.8.8
  register: ping_result
  ignore_errors: yes

- name: Show ping results
  debug:
    var: ping_result.stdout_lines


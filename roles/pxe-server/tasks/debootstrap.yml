---
# Pure debootstrap for NFS or local disk usage
# No PXE logic, just create and configure the Debian root

- name: Ensure network is ready on host
  lineinfile:
    path: /etc/resolv.conf
    line: "nameserver 8.8.8.8"
    state: present
    create: yes

- name: Wait for Debian mirror to be reachable
  wait_for:
    host: deb.debian.org
    port: 80
    timeout: 60

# ----------------------------
# Create directory for root filesystem
# ----------------------------
- name: Create NFS / PXE root directory
  file:
    path: /srv/live-build/pxe-root
    state: directory
    owner: root
    group: root
    mode: '0755'

# ----------------------------
# Bootstrap Debian base system
# ----------------------------
- name: Bootstrap Debian base system with debootstrap
  command: >
    debootstrap --arch=amd64 bookworm /srv/live-build/pxe-root http://deb.debian.org/debian
  args:
    creates: /srv/live-build/pxe-root/bin/bash

# ----------------------------
# Copy resolv.conf and sources.list into chroot
# ----------------------------
- name: Copy host resolv.conf into chroot
  copy:
    src: /etc/resolv.conf
    dest: /srv/live-build/pxe-root/etc/resolv.conf
    mode: '0644'

- name: Create minimal sources.list in chroot
  copy:
    dest: /srv/live-build/pxe-root/etc/apt/sources.list
    mode: '0644'
    content: |
      deb http://deb.debian.org/debian bookworm main contrib non-free
      deb http://deb.debian.org/debian bookworm-updates main contrib non-free
      deb http://security.debian.org/debian-security bookworm-security main contrib non-free

# ----------------------------
# Mount virtual filesystems for chroot
# ----------------------------
- name: Mount /proc, /sys, /dev inside chroot
  block:
    - mount: { path: /srv/live-build/pxe-root/proc, src: proc, fstype: proc, state: mounted }
    - mount: { path: /srv/live-build/pxe-root/sys, src: sysfs, fstype: sysfs, state: mounted }
    - mount: { path: /srv/live-build/pxe-root/dev, src: /dev, fstype: none, opts: bind, state: mounted }
    - mount: { path: /srv/live-build/pxe-root/dev/pts, src: /dev/pts, fstype: none, opts: bind, state: mounted }

# ----------------------------
# Install essential packages inside chroot
# ----------------------------
- name: Update APT inside chroot
  command: chroot /srv/live-build/pxe-root /bin/bash -c "apt-get update"
  environment:
    PATH: "/usr/sbin:/usr/bin:/sbin:/bin"

- name: Install essential packages inside chroot
  command: >
    chroot /srv/live-build/pxe-root /bin/bash -c
    "DEBIAN_FRONTEND=noninteractive apt-get install -y \
      initramfs-tools linux-image-amd64 nfs-common iproute2 net-tools \
      sudo vim curl wget"

- name: Clean apt cache inside chroot
  command: chroot /srv/live-build/pxe-root /bin/bash -c "apt-get clean"
  changed_when: false

# ----------------------------
# Setup users inside chroot
# ----------------------------
- name: Ensure admin user exists in chroot
  command: >
    chroot /srv/live-build/pxe-root /bin/bash -c
    "id -u blackpianocat >/dev/null 2>&1 || \
     (useradd -m -s /bin/bash blackpianocat && \
      echo 'blackpianocat:sebix4ever' | chpasswd && \
      usermod -aG sudo blackpianocat)"
  changed_when: false

# ----------------------------
# Configure basic networking & hostname
# ----------------------------
- name: Set hostname in chroot
  copy:
    dest: /srv/live-build/pxe-root/etc/hostname
    content: "pxeclient\n"

- name: Create hosts file in chroot
  copy:
    dest: /srv/live-build/pxe-root/etc/hosts
    content: |
      127.0.0.1 localhost
      127.0.1.1 pxeclient

# ----------------------------
# Update initramfs inside chroot
# ----------------------------
- name: Update initramfs in chroot
  command: chroot /srv/live-build/pxe-root /bin/bash -c "update-initramfs -u -k all"
  environment:
    PATH: "/usr/sbin:/usr/bin:/sbin:/bin"

# ----------------------------
# Unmount virtual filesystems before exporting
# ----------------------------
# ----------------------------
# Unmount virtual filesystems after chroot setup
# ----------------------------
- name: Unmount /proc, /sys, /dev, /dev/pts in correct order
  block:
    - name: Unmount /dev/pts
      command: umount -l /srv/live-build/pxe-root/dev/pts
      ignore_errors: yes

    - name: Unmount /dev
      command: umount -l /srv/live-build/pxe-root/dev
      ignore_errors: yes

    - name: Unmount /sys
      command: umount -l /srv/live-build/pxe-root/sys
      ignore_errors: yes

    - name: Unmount /proc
      command: umount -l /srv/live-build/pxe-root/proc
      ignore_errors: yes


# ----------------------------
# Ensure rsync is installed
# ----------------------------
- name: Ensure rsync is installed
  apt:
    name: rsync
    state: present
    update_cache: yes

# ----------------------------
# Copy completed root to final location
# ----------------------------
- name: Create final PXE root directory
  file:
    path: /srv/debian-root
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Copy completed root to final location
  shell: >
    rsync -a --one-file-system \
      --exclude=/proc --exclude=/proc/* \
      --exclude=/sys --exclude=/sys/* \
      --exclude=/dev --exclude=/dev/* \
      --exclude=/dev/pts --exclude=/tmp --exclude=/run \
      /srv/live-build/pxe-root/ /srv/debian-root/

- name: Set correct permissions on PXE root
  file:
    path: /srv/debian-root
    state: directory
    recurse: yes
    owner: root
    group: root
    mode: '0755'
  become: yes


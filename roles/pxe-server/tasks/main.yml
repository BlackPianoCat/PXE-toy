---
# ===========================
# PXE + Clonezilla + Debian Netboot Server Setup (Debian)
# ===========================

# ----------------------------
# Detect PXE interface (host-only adapter)
# ----------------------------
- name: Detect PXE interface (host-only adapter)
  shell: ip route | awk '/default/ {print $5}'
  register: iface_result
  changed_when: false
  failed_when: iface_result.rc != 0 or iface_result.stdout == ""

- name: Set PXE interface fact
  set_fact:
    pxe_interface: "{{ iface_result.stdout | trim | default('eth1') }}"

- name: Show selected PXE interface
  debug:
    msg: "Using PXE interface: {{ pxe_interface }}"

# ----------------------------
# Install packages
# ----------------------------
- name: Install PXE, TFTP, NFS, and dependencies
  apt:
    name:
      - dnsmasq
      - pxelinux
      - syslinux-common
      - nfs-kernel-server
      - unzip
      - net-tools
      - tftp
      - wget
    state: present
    update_cache: yes

# ----------------------------
# Configure dnsmasq
# ----------------------------
- name: Configure dnsmasq
  copy:
    dest: /etc/dnsmasq.d/pxe.conf
    content: |
      interface={{ pxe_interface }}
      bind-interfaces
      dhcp-range=192.168.56.100,192.168.56.200,12h
      dhcp-boot=pxelinux.0
      enable-tftp
      tftp-root=/srv/tftp
  notify: Restart dnsmasq

# ----------------------------
# Setup TFTP root
# ----------------------------
- name: Create TFTP root directory
  file:
    path: /srv/tftp
    state: directory
    owner: root
    group: root
    mode: '0755'

# ----------------------------
# PXELINUX bootloader
# ----------------------------
- name: Find pxelinux.0 in system
  shell: |
    for d in /usr/lib/PXELINUX /usr/lib/syslinux /usr/share/syslinux /usr/lib/syslinux/modules/bios; do
      if [ -f "$d/pxelinux.0" ]; then echo "$d/pxelinux.0"; exit 0; fi
    done
  register: pxelinux_path
  failed_when: pxelinux_path.rc != 0 or pxelinux_path.stdout == ""
  changed_when: false

- name: Copy PXE bootloader
  copy:
    remote_src: yes
    src: "{{ pxelinux_path.stdout }}"
    dest: /srv/tftp/pxelinux.0
    mode: '0644'

# ----------------------------
# Copy syslinux BIOS modules
# ----------------------------
- name: Copy syslinux BIOS modules to TFTP
  shell: |
    mkdir -p /srv/tftp/modules
    cp -a /usr/lib/syslinux/modules/bios/* /srv/tftp/modules/
  args:
    executable: /bin/bash

# ----------------------------
# PXE menu directory
# ----------------------------
- name: Ensure PXE menu directory
  file:
    path: /srv/tftp/pxelinux.cfg
    state: directory
    mode: '0755'

# ----------------------------
# Download and extract Clonezilla Live
# ----------------------------
- name: Create Clonezilla Live folder
  file:
    path: /srv/tftp/clonezilla/live
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Download Clonezilla Live ZIP (if not present)
  get_url:
    url: "https://netcologne.dl.sourceforge.net/project/clonezilla/clonezilla_live_stable/3.2.2-15/clonezilla-live-3.2.2-15-amd64.zip"
    dest: /tmp/clonezilla-live.zip
    mode: '0644'
  when: not ("/tmp/clonezilla-live.zip" is file)

- name: Extract Clonezilla Live to correct folder
  unarchive:
    src: /tmp/clonezilla-live.zip
    dest: /srv/tftp/clonezilla/live
    remote_src: yes

# ----------------------------
# Download Debian netboot
# ----------------------------
- name: Create Debian netboot folder
  file:
    path: /srv/tftp/debian
    state: directory
    mode: '0755'

- name: Download Debian vmlinuz
  get_url:
    url: http://ftp.debian.org/debian/dists/trixie/main/installer-amd64/current/images/netboot/debian-installer/amd64/linux
    dest: /srv/tftp/debian/vmlinuz
    mode: '0644'

- name: Download Debian initrd.gz
  get_url:
    url: http://ftp.debian.org/debian/dists/trixie/main/installer-amd64/current/images/netboot/debian-installer/amd64/initrd.gz
    dest: /srv/tftp/debian/initrd.gz
    mode: '0644'

# ----------------------------
# Create PXE default menu
# ----------------------------
- name: Create PXE default menu
  copy:
    dest: /srv/tftp/pxelinux.cfg/default
    content: |
      DEFAULT menu.c32
      PROMPT 0
      TIMEOUT 50
      MENU TITLE PXE Boot Menu

      LABEL debian
        MENU LABEL Debian Installer
        KERNEL debian/vmlinuz
        APPEND initrd=debian/initrd.gz

      LABEL clonezilla
        MENU LABEL Clonezilla Live
        KERNEL clonezilla/live/vmlinuz
        APPEND initrd=clonezilla/live/initrd.img boot=live username=user hostname=clonezilla fetch=tftp://{{ pxe_interface }}/clonezilla/live/filesystem.squashfs

# ----------------------------
# Service management
# ----------------------------
- name: Restart dnsmasq
  service:
    name: dnsmasq
    state: restarted
    enabled: yes

- name: Ensure NFS is enabled
  service:
    name: nfs-kernel-server
    state: started
    enabled: yes


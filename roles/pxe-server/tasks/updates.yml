---
# roles/pxe-server/tasks/updates.yml
# Update and upgrade the PXE bootstraped Debian system

- name: Ensure PXE root exists
  file:
    path: /srv/live-build/pxe-root
    state: directory

# Ensure virtual filesystems exist for chroot
- name: Ensure /proc, /sys, /dev, /dev/pts exist
  file:
    path: "{{ item }}"
    state: directory
  loop:
    - /srv/live-build/pxe-root/proc
    - /srv/live-build/pxe-root/sys
    - /srv/live-build/pxe-root/dev
    - /srv/live-build/pxe-root/dev/pts

# Mount virtual filesystems for apt inside chroot
- name: Mount /proc
  mount:
    path: /srv/live-build/pxe-root/proc
    src: proc
    fstype: proc
    state: mounted

- name: Mount /sys
  mount:
    path: /srv/live-build/pxe-root/sys
    src: sysfs
    fstype: sysfs
    state: mounted

- name: Bind-mount /dev
  mount:
    path: /srv/live-build/pxe-root/dev
    src: /dev
    opts: bind
    state: mounted

- name: Bind-mount /dev/pts
  mount:
    path: /srv/live-build/pxe-root/dev/pts
    src: /dev/pts
    opts: bind
    state: mounted

# Update and upgrade inside PXE root
- name: Update apt cache inside PXE root
  command: chroot /srv/live-build/pxe-root /bin/bash -c "apt-get update"

- name: Upgrade all packages inside PXE root
  command: chroot /srv/live-build/pxe-root /bin/bash -c "DEBIAN_FRONTEND=noninteractive apt-get -y upgrade"

# Clean apt cache to save space
- name: Clean apt cache inside PXE root
  command: chroot /srv/live-build/pxe-root /bin/bash -c "apt-get clean"

# Unmount virtual filesystems
- name: Unmount /proc
  command: umount /srv/live-build/pxe-root/proc
  ignore_errors: yes

- name: Unmount /sys
  command: umount /srv/live-build/pxe-root/sys
  ignore_errors: yes

- name: Unmount /dev/pts
  command: umount /srv/live-build/pxe-root/dev/pts
  ignore_errors: yes

- name: Unmount /dev
  command: umount /srv/live-build/pxe-root/dev
  ignore_errors: yes


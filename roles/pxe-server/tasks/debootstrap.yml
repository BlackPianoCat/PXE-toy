---
# PXE Debian boot using debootstrap and NFS root
# Robust, idempotent version: ensures files persist, exports are correct,
# copies required pxelinux modules, restarts services and clears leases.

# NOTE: This playbook assumes setup.yml already installed dnsmasq and created /srv/tftp
# and that `pxe_interface` fact exists (from setup.yml). If not, pxe_interface defaults to eth1.

# ----------------------------
# Detect PXE interface IP (calculate and expose pxe_ip)
# ----------------------------
- name: Detect PXE interface IP
  shell: |
    ip -4 addr show dev {{ pxe_interface | default('eth1') }} \
      | awk '/inet / {gsub("/.*","",$2); print $2; exit}'
  register: pxe_ip
  changed_when: false
  failed_when: pxe_ip.stdout == ""
  tags: always

- name: Debug show detected PXE IP
  debug:
    msg: "PXE server IP: {{ pxe_ip.stdout }} (interface: {{ pxe_interface | default('eth1') }})"

# ----------------------------
# Ensure basic network resolution for apt in chroot
# ----------------------------
- name: Ensure DNS resolver is present on host (for debootstrap/chroot)
  lineinfile:
    path: /etc/resolv.conf
    line: "nameserver 8.8.8.8"
    state: present
    create: yes

- name: Wait for deb.debian.org to be reachable
  wait_for:
    host: deb.debian.org
    port: 80
    timeout: 60

# ----------------------------
# Create persistent directories (idempotent)
# ----------------------------
- name: Create required directories (PXE root + TFTP)
  file:
    path: "{{ item }}"
    state: directory
    owner: nobody
    group: nogroup
    mode: '0755'
  loop:
    - /srv/live-build/pxe-root
    - /srv/tftp
    - /srv/tftp/modules
    - /srv/tftp/pxelinux.cfg

# ----------------------------
# Bootstrap minimal Debian (debootstrap)
# ----------------------------
- name: Bootstrap Debian base system (debootstrap)
  command: >
    debootstrap --arch=amd64 bookworm /srv/live-build/pxe-root http://deb.debian.org/debian
  args:
    creates: /srv/live-build/pxe-root/bin/bash

# ----------------------------
# Ensure apt sources inside the chroot
# ----------------------------
- name: Copy host resolv.conf into chroot (so apt can resolve)
  copy:
    src: /etc/resolv.conf
    dest: /srv/live-build/pxe-root/etc/resolv.conf
    mode: '0644'

- name: Create minimal sources.list in chroot
  copy:
    dest: /srv/live-build/pxe-root/etc/apt/sources.list
    mode: '0644'
    content: |
      deb http://deb.debian.org/debian bookworm main contrib non-free
      deb http://deb.debian.org/debian bookworm-updates main contrib non-free
      deb http://security.debian.org/debian-security bookworm-security main contrib non-free

# ----------------------------
# Mount virtual filesystems BEFORE running apt inside chroot
# ----------------------------
- name: Bind /tmp inside chroot
  mount:
    path: /srv/live-build/pxe-root/tmp
    src: /tmp
    fstype: none
    opts: bind
    state: mounted

- name: Mount /proc, /sys, /dev, /dev/pts into chroot
  block:
    - mount: { path: /srv/live-build/pxe-root/proc, src: proc, fstype: proc, state: mounted }
    - mount: { path: /srv/live-build/pxe-root/sys, src: sysfs, fstype: sysfs, state: mounted }
    - mount: { path: /srv/live-build/pxe-root/dev, src: /dev, fstype: none, opts: bind, state: mounted }
    - mount: { path: /srv/live-build/pxe-root/dev/pts, src: /dev/pts, fstype: none, opts: bind, state: mounted }

# ----------------------------
# Update apt inside chroot and install required packages
# Important: use full PATH and single chroot command lines.
# ----------------------------
- name: Update APT package lists inside chroot
  command: chroot /srv/live-build/pxe-root /bin/bash -c "apt-get update"
  environment:
    PATH: "/usr/sbin:/usr/bin:/sbin:/bin"
  register: apt_update
  failed_when: apt_update.rc != 0

- name: Install essential packages inside chroot (initramfs + kernel + nfs + pxelinux)
  command: >
    chroot /srv/live-build/pxe-root /bin/bash -c
    "DEBIAN_FRONTEND=noninteractive apt-get install -y \
      initramfs-tools linux-image-amd64 nfs-common iproute2 net-tools \
      sudo vim curl wget syslinux-common pxelinux"
  environment:
    PATH: "/usr/sbin:/usr/bin:/sbin:/bin"
  register: apt_install
  failed_when: apt_install.rc != 0

- name: Clean apt cache inside chroot
  command: chroot /srv/live-build/pxe-root /bin/bash -c "apt-get clean"
  changed_when: false

# ----------------------------
# Create users and sudoers inside chroot
# ----------------------------
- name: Ensure admin user blackpianocat exists in chroot
  command: >
    chroot /srv/live-build/pxe-root /bin/bash -c
    "id -u blackpianocat >/dev/null 2>&1 || \
     (useradd -m -s /bin/bash blackpianocat && \
      echo 'blackpianocat:sebix4ever' | chpasswd && \
      usermod -aG sudo blackpianocat)"
  changed_when: false

- name: Ensure standard users exist in chroot
  loop:
    - kotek-1
    - kotek-2
  command: >
    chroot /srv/live-build/pxe-root /bin/bash -c
    "id -u {{ item }} >/dev/null 2>&1 || useradd -m -s /bin/bash {{ item }}"
  changed_when: false

- name: Give admin passwordless sudo inside chroot
  copy:
    dest: /srv/live-build/pxe-root/etc/sudoers.d/blackpianocat
    mode: '0440'
    content: |
      blackpianocat ALL=(ALL) NOPASSWD: ALL

# ----------------------------
# Ensure initramfs contains NFS support and regenerate
# (this ensures clients can mount NFS root)
# ----------------------------
- name: Ensure NFS modules present in initramfs-tools/modules inside chroot
  block:
    - name: Add NFS modules to /etc/initramfs-tools/modules (idempotent)
      lineinfile:
        path: /srv/live-build/pxe-root/etc/initramfs-tools/modules
        line: "{{ item }}"
        create: yes
      loop:
        - nfs
        - nfsv3
        - nfsv4
        - ext4

    - name: Update-initramfs inside chroot (regenerate for installed kernel)
      command: chroot /srv/live-build/pxe-root /bin/bash -c "update-initramfs -u -k all"
      environment:
        PATH: "/usr/sbin:/usr/bin:/sbin:/bin"

# ----------------------------
# Copy pxelinux bootloader and syslinux modules to TFTP root
# (ensure ldlinux.c32 and other .c32 are present)
# ----------------------------
- name: Find pxelinux.0 on host
  shell: |
    for d in /usr/lib/PXELINUX /usr/lib/syslinux /usr/share/syslinux /usr/lib/syslinux/modules/bios; do
      if [ -f "$d/pxelinux.0" ]; then echo "$d/pxelinux.0"; exit 0; fi
    done
  register: pxelinux_path
  changed_when: false
  failed_when: pxelinux_path.stdout == ""

- name: Copy pxelinux.0 to TFTP root
  copy:
    remote_src: yes
    src: "{{ pxelinux_path.stdout }}"
    dest: /srv/tftp/pxelinux.0
    mode: '0644'

- name: Copy syslinux core .c32 files to TFTP root (ldlinux.c32 etc)
  shell: |
    set -e
    for f in /usr/lib/syslinux/*.c32 /usr/lib/PXELINUX/*.c32 /usr/lib/syslinux/modules/bios/*.c32; do
      if [ -f "$f" ]; then cp -f "$f" /srv/tftp/; fi
    done
    # Also copy any .c32 from /usr/lib/x86_64-linux-gnu/syslinux if present
    for f in /usr/lib/x86_64-linux-gnu/syslinux/*.c32; do
      [ -f "$f" ] && cp -f "$f" /srv/tftp/ || true
    done
  args:
    executable: /bin/bash

# ----------------------------
# Copy kernel and initrd from chroot to TFTP with stable names
# ----------------------------
- name: Ensure chroot /boot exists (fail early if not)
  stat:
    path: /srv/live-build/pxe-root/boot
  register: chroot_boot

- name: Fail if no kernel found in chroot boot
  fail:
    msg: "No kernel found under /srv/live-build/pxe-root/boot â€” debootstrap or package install probably failed."
  when: not chroot_boot.stat.exists

- name: Copy vmlinuz and initrd from chroot to /srv/tftp with stable names
  shell: |
    set -e
    # pick the newest vmlinuz-* and initrd.img-* files
    vmlinuz=$(ls -1t /srv/live-build/pxe-root/boot/vmlinuz-* 2>/dev/null | head -n1)
    initrd=$(ls -1t /srv/live-build/pxe-root/boot/initrd.img-* 2>/dev/null | head -n1)
    if [ -z "$vmlinuz" ] || [ -z "$initrd" ]; then
      echo "ERROR: kernel or initrd not found" >&2
      exit 2
    fi
    cp -f "$vmlinuz" /srv/tftp/vmlinuz
    cp -f "$initrd" /srv/tftp/initrd.img
  args:
    executable: /bin/bash

- name: Ensure TFTP files are readable
  file:
    path: "{{ item }}"
    mode: '0644'
  loop:
    - /srv/tftp/vmlinuz
    - /srv/tftp/initrd.img
    - /srv/tftp/pxelinux.0
    - /srv/tftp/ldlinux.c32
  ignore_errors: yes

# ----------------------------
# Create pxelinux.cfg/default (menu)
# ----------------------------
- name: Configure PXE menu for NFS root (writes exact nfsroot using detected IP)
  copy:
    dest: /srv/tftp/pxelinux.cfg/default
    mode: '0644'
    content: |
      DEFAULT debian
      PROMPT 0
      TIMEOUT 50

      LABEL debian
        MENU LABEL Boot Debian PXE (NFS root)
        KERNEL vmlinuz
        INITRD initrd.img
        APPEND root=/dev/nfs nfsroot={{ pxe_ip.stdout }}:/srv/live-build/pxe-root,rw ip=dhcp nfsrootwait

# ----------------------------
# Ensure permissions and ownership for TFTP and PXE files
# ----------------------------
- name: Ensure /srv/tftp ownership and modes
  file:
    path: /srv/tftp
    owner: nobody
    group: nogroup
    mode: '0755'
    recurse: no

- name: Ensure pxelinux.cfg directory is readable
  file:
    path: /srv/tftp/pxelinux.cfg
    mode: '0755'

# ----------------------------
# Export NFS root: compute network and write export file idempotently
# ----------------------------
- name: Compute PXE network (assume /24)
  set_fact:
    pxe_network: "{{ pxe_ip.stdout | regex_replace('([0-9]+)$','0') }}/24"

- name: Ensure /etc/exports.d exists
  file:
    path: /etc/exports.d
    state: directory
    mode: '0755'

- name: Configure NFS export for PXE root
  copy:
    dest: /etc/exports.d/pxe-root.exports
    mode: '0644'
    content: "/srv/live-build/pxe-root {{ pxe_network }}(rw,no_root_squash,no_subtree_check)"

# ----------------------------
# Reload exports and ensure services are up
# ----------------------------
- name: Reload NFS exports (exportfs -ra)
  command: exportfs -ra
  register: exportfs_out
  failed_when: exportfs_out.rc != 0
  changed_when: false

- name: Ensure nfs-kernel-server is started and enabled
  service:
    name: nfs-kernel-server
    state: started
    enabled: yes

# ----------------------------
# Ensure dnsmasq will point to this pxelinux.0 (fix leases, restart)
# This guarantees DHCP next-server points to the correct IP and removes stale leases.
# ----------------------------
- name: Remove dnsmasq lease file (if present) to avoid stale client behaviour
  file:
    path: /var/lib/misc/dnsmasq.leases
    state: absent
  ignore_errors: yes

- name: Restart dnsmasq so DHCP/next-server is fresh
  systemd:
    name: dnsmasq
    state: restarted
    enabled: yes

# ----------------------------
# Check that all required TFTP files exist and show debug info
# ----------------------------
- name: Check TFTP pxelinux.0 exists
  stat:
    path: /srv/tftp/pxelinux.0
  register: stat_pxelinux

- name: Check TFTP ldlinux.c32 exists
  stat:
    path: /srv/tftp/ldlinux.c32
  register: stat_ldlinux

- name: Check TFTP vmlinuz/initrd exist
  stat:
    path: /srv/tftp/vmlinuz
  register: stat_vmlinuz

- name: Check TFTP initrd
  stat:
    path: /srv/tftp/initrd.img
  register: stat_initrd

- name: Debug TFTP files status
  debug:
    msg: |
      pxelinux.0: {{ stat_pxelinux.stat.exists }}
      ldlinux.c32: {{ stat_ldlinux.stat.exists }}
      vmlinuz: {{ stat_vmlinuz.stat.exists }}
      initrd.img: {{ stat_initrd.stat.exists }}
      NFS export: {{ pxe_network }}

# ----------------------------
# Unmount virtual filesystems (cleanup)
# ----------------------------
- name: Unmount virtual filesystems (best-effort)
  block:
    - shell: umount /srv/live-build/pxe-root/dev/pts || true
    - shell: umount /srv/live-build/pxe-root/dev || true
    - shell: umount /srv/live-build/pxe-root/sys || true
    - shell: umount /srv/live-build/pxe-root/proc || true
    - shell: umount /srv/live-build/pxe-root/tmp || true
  ignore_errors: yes

- name: Final debug - PXE root ready
  debug:
    msg: "PXE root and TFTP files are ready. Boot clients from PXE (pxelinux.0 -> loads ldlinux.c32 -> menu -> vmlinuz+initrd -> NFS root)."

# ----------------------------
# Handlers
# ----------------------------
# Note: handlers must be declared at the end of the file when not using a role handlers file.
- name: Reload NFS exports
  command: exportfs -ra
  notify: reload-nfs


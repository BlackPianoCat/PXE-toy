---
# ===========================
# PXE + NFS-root Debian boot (no Clonezilla)
# ===========================

# ----------------------------
# Detect PXE interface (host-only adapter)
# ----------------------------
- name: Detect PXE interface
  shell: ip -o -4 addr show | awk '/192\.168\.56\./ {print $2; exit}'
  register: iface_result
  changed_when: false
  failed_when: iface_result.rc != 0 or iface_result.stdout == ""

- name: Set PXE interface fact
  set_fact:
    pxe_interface: "{{ iface_result.stdout | trim }}"

- name: Detect PXE interface IP
  shell: ip -4 addr show {{ pxe_interface }} | awk '/inet / {gsub("/.*","",$2); print $2}'
  register: pxe_ip
  changed_when: false

- debug:
    msg: "PXE interface: {{ pxe_interface }}, IP: {{ pxe_ip.stdout }}"

# ----------------------------
# Install PXE, NFS, and utilities
# ----------------------------
- name: Install required packages
  apt:
    name:
      - dnsmasq
      - pxelinux
      - syslinux-common
      - nfs-kernel-server
      - unzip
      - net-tools
      - tftp
    state: present
    update_cache: yes

# ----------------------------
# Prepare TFTP root
# ----------------------------
- name: Create TFTP directories
  file:
    path: "{{ item }}"
    state: directory
    owner: nobody
    group: nogroup
    mode: '0755'
  loop:
    - /srv/tftp
    - /srv/tftp/modules

# ----------------------------
# Copy PXE bootloader
# ----------------------------
- name: Find pxelinux.0 in system
  shell: |
    for d in /usr/lib/PXELINUX /usr/lib/syslinux /usr/share/syslinux /usr/lib/syslinux/modules/bios; do
      if [ -f "$d/pxelinux.0" ]; then echo "$d/pxelinux.0"; exit 0; fi
    done
  register: pxelinux_path
  changed_when: false
  failed_when: pxelinux_path.stdout == ""

- name: Copy pxelinux.0 to TFTP
  copy:
    remote_src: yes
    src: "{{ pxelinux_path.stdout }}"
    dest: /srv/tftp/pxelinux.0
    mode: '0644'

# ----------------------------
# Copy syslinux BIOS modules
# ----------------------------
- name: Copy syslinux BIOS modules
  shell: |
    for d in /usr/lib/syslinux/modules/bios /usr/share/syslinux; do
      if [ -d "$d" ]; then cp -a $d/* /srv/tftp/modules/; fi
    done
    cp -a /usr/lib/syslinux/*.c32 /srv/tftp/ 2>/dev/null || true
  args:
    executable: /bin/bash

# ----------------------------
# Create PXE config directory
# ----------------------------
- name: Ensure pxelinux.cfg directory exists
  file:
    path: /srv/tftp/pxelinux.cfg
    state: directory
    owner: nobody
    group: nogroup
    mode: '0755'

# ----------------------------
# Create real PXE boot menu
# ----------------------------
- name: Install proper PXE boot menu
  copy:
    dest: /srv/tftp/pxelinux.cfg/default
    owner: nobody
    group: nogroup
    mode: '0644'
    content: |
      DEFAULT debian
      PROMPT 0
      TIMEOUT 30

      LABEL debian
        KERNEL vmlinuz
        INITRD initrd.img
        APPEND root=/dev/nfs nfsroot={{ pxe_ip.stdout }}:/srv/nfs/debian rw ip=dhcp

# ----------------------------
# Configure dnsmasq for PXE
# ----------------------------
- name: Backup dnsmasq.conf if not already backed up
  copy:
    src: /etc/dnsmasq.conf
    dest: /etc/dnsmasq.conf.bak
    remote_src: yes
    force: no

- name: Configure dnsmasq PXE
  copy:
    dest: /etc/dnsmasq.d/pxe.conf
    mode: '0644'
    content: |
      interface={{ pxe_interface }}
      bind-interfaces
      dhcp-range=192.168.56.100,192.168.56.200,12h
      dhcp-boot=pxelinux.0
      pxe-service=x86PC,"PXE Boot",pxelinux.0
      enable-tftp
      tftp-root=/srv/tftp
      log-dhcp
      # Force next-server to PXE server IP for multi-network clients
      dhcp-option=66,{{ pxe_ip.stdout }}

# ----------------------------
# Restart dnsmasq
# ----------------------------
- name: Restart dnsmasq
  systemd:
    name: dnsmasq
    state: restarted
    enabled: yes


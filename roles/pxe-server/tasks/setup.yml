---
# PXE server setup using a pre-built Debian root at /srv/debian-root

# ----------------------------
# Detect PXE interface and IP
# ----------------------------
- name: Detect PXE interface
  shell: ip -o -4 addr show | awk '/192\.168\.56\./ {print $2; exit}'
  register: iface_result
  changed_when: false
  failed_when: iface_result.rc != 0 or iface_result.stdout == ""

- name: Set PXE interface fact
  set_fact:
    pxe_interface: "{{ iface_result.stdout | trim }}"

- name: Detect PXE interface IP
  shell: ip -4 addr show {{ pxe_interface }} | awk '/inet / {gsub("/.*","",$2); print $2}'
  register: pxe_ip
  changed_when: false

- debug:
    msg: "PXE interface: {{ pxe_interface }}, IP: {{ pxe_ip.stdout }}"

# ----------------------------
# Install PXE-related packages
# ----------------------------
- name: Install required packages
  apt:
    name:
      - dnsmasq
      - pxelinux
      - syslinux-common
      - nfs-kernel-server
      - tftp
      - unzip
      - net-tools
    state: present
    update_cache: yes

# ----------------------------
# Prepare TFTP directories
# ----------------------------
- name: Create TFTP directories
  file:
    path: "{{ item }}"
    state: directory
    owner: nobody
    group: nogroup
    mode: '0755'
  loop:
    - /srv/tftp
    - /srv/tftp/pxelinux.cfg

# ----------------------------
# Copy pxelinux binaries and modules
# ----------------------------
- name: Find pxelinux.0
  shell: |
    for d in /usr/lib/PXELINUX /usr/lib/syslinux /usr/share/syslinux /usr/lib/syslinux/modules/bios; do
      [ -f "$d/pxelinux.0" ] && echo "$d/pxelinux.0" && exit 0
    done
  register: pxelinux_path
  changed_when: false

- name: Copy pxelinux.0 to TFTP
  copy:
    remote_src: yes
    src: "{{ pxelinux_path.stdout }}"
    dest: /srv/tftp/pxelinux.0
    mode: '0644'

- name: Copy .c32 modules to TFTP
  shell: |
    for dir in /usr/lib/syslinux /usr/lib/PXELINUX /usr/lib/syslinux/modules/bios /usr/lib/x86_64-linux-gnu/syslinux; do
      [ -d "$dir" ] || continue
      cp -f "$dir"/*.c32 /srv/tftp/ 2>/dev/null || true
    done
  args:
    executable: /bin/bash

# ----------------------------
# Copy kernel and initrd from /srv/debian-root
# ----------------------------
- name: Copy vmlinuz and initrd.img
  shell: |
    set -e
    vmlinuz=$(ls -1t /srv/debian-root/boot/vmlinuz-* | head -n1)
    initrd=$(ls -1t /srv/debian-root/boot/initrd.img-* | head -n1)
    cp -f "$vmlinuz" /srv/tftp/vmlinuz
    cp -f "$initrd" /srv/tftp/initrd.img
  args:
    executable: /bin/bash

# ----------------------------
# Configure PXE boot menu
# ----------------------------
- name: Create PXE boot menu
  copy:
    dest: /srv/tftp/pxelinux.cfg/default
    mode: '0644'
    content: |
      DEFAULT debian
      PROMPT 0
      TIMEOUT 20

      LABEL debian
        MENU LABEL Debian PXE (NFS root)
        KERNEL vmlinuz
        INITRD initrd.img
        APPEND root=/dev/nfs ip=dhcp \
          nfsroot={{ pxe_ip.stdout }}:/srv/debian-root,vers=3,rw \
          nfsrootdebug

# ----------------------------
# Ensure NFS export exists
# ----------------------------
- name: Ensure /srv/debian-root exists
  file:
    path: /srv/debian-root
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Compute PXE network
  set_fact:
    pxe_network: "{{ pxe_ip.stdout | regex_replace('([0-9]+)$','0') }}/24"

- name: Export PXE root via NFS
  copy:
    dest: /etc/exports.d/pxe-root.exports
    mode: '0644'
    content: |
      /srv/debian-root {{ pxe_network }}(rw,async,no_root_squash,no_subtree_check)

- name: Reload NFS exports
  command: exportfs -ra

- name: Ensure nfs-kernel-server is started
  service:
    name: nfs-kernel-server
    state: started
    enabled: yes

# ----------------------------
# Configure dnsmasq for PXE
# ----------------------------
- name: Backup dnsmasq.conf if not exists
  copy:
    src: /etc/dnsmasq.conf
    dest: /etc/dnsmasq.conf.bak
    remote_src: yes
    force: no

- name: Configure dnsmasq for PXE
  copy:
    dest: /etc/dnsmasq.d/pxe.conf
    mode: '0644'
    content: |
      interface={{ pxe_interface }}
      bind-interfaces
      dhcp-range=192.168.56.100,192.168.56.200,12h
      dhcp-boot=pxelinux.0
      pxe-service=x86PC,"PXE Boot",pxelinux.0
      enable-tftp
      tftp-root=/srv/tftp
      log-dhcp
      dhcp-option=66,{{ pxe_ip.stdout }}

# ----------------------------
# Restart services
# ----------------------------
- name: Remove dnsmasq lease file
  file:
    path: /var/lib/misc/dnsmasq.leases
    state: absent
  ignore_errors: yes

- name: Restart dnsmasq
  systemd:
    name: dnsmasq
    state: restarted
    enabled: yes


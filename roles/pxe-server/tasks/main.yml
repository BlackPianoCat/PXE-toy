---
# ===========================
# PXE + Clonezilla Server Setup (Debian)
# ===========================

# ----------------------------
# Detect PXE interface (host-only adapter)
# ----------------------------
- name: Detect PXE interface (host-only adapter)
  shell: ip route | awk '/default/ {print $5}'
  register: iface_result
  changed_when: false
  failed_when: iface_result.rc != 0 or iface_result.stdout == ""

- name: Set PXE interface fact
  set_fact:
    pxe_interface: "{{ iface_result.stdout | trim | default('eth1') }}"

- name: Show selected PXE interface
  debug:
    msg: "Using PXE interface: {{ pxe_interface }}"

# ----------------------------
# Install packages
# ----------------------------
- name: Install PXE, NFS, and Clonezilla dependencies
  apt:
    name:
      - dnsmasq
      - pxelinux
      - syslinux-common
      - nfs-kernel-server
      - unzip
      - net-tools
      - tftp
    state: present
    update_cache: yes

# ----------------------------
# Configure dnsmasq (DHCP + PXE)
# ----------------------------
- name: Configure dnsmasq
  copy:
    dest: /etc/dnsmasq.d/pxe.conf
    content: |
      interface={{ pxe_interface }}
      bind-interfaces
      dhcp-range=192.168.56.100,192.168.56.200,12h
      dhcp-boot=pxelinux.0
      enable-tftp
      tftp-root=/srv/tftp
  notify: Restart dnsmasq

# ----------------------------
# Setup TFTP root
# ----------------------------
- name: Create TFTP directory
  file:
    path: /srv/tftp
    state: directory
    owner: root
    group: root
    mode: '0755'

# ----------------------------
# PXELINUX bootloader
# ----------------------------
- name: Find pxelinux.0 in system
  shell: |
    for d in /usr/lib/PXELINUX /usr/lib/syslinux /usr/share/syslinux /usr/lib/syslinux/modules/bios; do
      if [ -f "$d/pxelinux.0" ]; then echo "$d/pxelinux.0"; exit 0; fi
    done
  register: pxelinux_path
  failed_when: pxelinux_path.rc != 0 or pxelinux_path.stdout == ""
  changed_when: false

- name: Show found pxelinux path
  debug:
    msg: "Found pxelinux.0 at {{ pxelinux_path.stdout }}"

- name: Copy PXE bootloader
  copy:
    remote_src: yes
    src: "{{ pxelinux_path.stdout }}"
    dest: /srv/tftp/pxelinux.0
    mode: '0644'

# ----------------------------
# Copy syslinux BIOS modules
# ----------------------------
- name: Copy syslinux BIOS modules to TFTP
  shell: |
    mkdir -p /srv/tftp/modules
    for d in /usr/lib/syslinux/modules/bios /usr/share/syslinux; do
      if [ -d "$d" ]; then cp -a $d/* /srv/tftp/modules/; fi
    done

# ----------------------------
# Download and unpack Clonezilla Live
# ----------------------------
- name: Download Clonezilla Live ZIP (if not present)
  get_url:
    url: "https://netcologne.dl.sourceforge.net/project/clonezilla/clonezilla_live_stable/3.2.2-15/clonezilla-live-3.2.2-15-amd64.zip"
    dest: /tmp/clonezilla-live.zip
    mode: '0644'
  when: not ("/tmp/clonezilla-live.zip" is file)

- name: Extract Clonezilla Live
  unarchive:
    src: /tmp/clonezilla-live.zip
    dest: /srv/tftp/
    remote_src: yes

# ----------------------------
# PXE boot menu configuration
# ----------------------------
- name: Create PXE menu directory
  file:
    path: /srv/tftp/pxelinux.cfg
    state: directory

- name: Create PXE default menu
  copy:
    dest: /srv/tftp/pxelinux.cfg/default
    content: |
      DEFAULT menu.c32
      PROMPT 0
      TIMEOUT 50
      MENU TITLE PXE Boot Menu

      LABEL clonezilla
        MENU LABEL Clonezilla Live
        KERNEL live/vmlinuz
        APPEND initrd=live/initrd.img boot=live username=user hostname=clonezilla fetch=tftp://192.168.56.1/live/filesystem.squashfs

# ----------------------------
# Service management
# ----------------------------
- name: Restart dnsmasq
  service:
    name: dnsmasq
    state: restarted
    enabled: yes

- name: Ensure NFS is enabled
  service:
    name: nfs-kernel-server
    state: started
    enabled: yes

# ----------------------------
# Diagnostics and verification
# ----------------------------
- name: Check if dnsmasq is listening on port 69 (TFTP)
  shell: netstat -ulnp | grep ':69'
  register: tftp_check
  ignore_errors: yes
  changed_when: false

- name: Show TFTP socket check result
  debug:
    msg: "{{ tftp_check.stdout | default('⚠️ No TFTP socket found') }}"

- name: Check TFTP accessibility for pxelinux.0
  shell: "echo 'get pxelinux.0' | tftp 192.168.56.1 -v -m binary"
  register: tftp_test
  ignore_errors: yes
  changed_when: false

- name: Show TFTP test result
  debug:
    msg: "{{ tftp_test.stdout | default('⚠️ TFTP test failed') }}"

- name: List TFTP root contents
  command: ls -R /srv/tftp
  register: tftp_dir
  changed_when: false

- name: Display TFTP directory structure
  debug:
    var: tftp_dir.stdout


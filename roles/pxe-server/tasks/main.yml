---
- name: Install PXE packages
  apt:
    name:
      - dnsmasq
      - pxelinux
      - syslinux-common
      - nfs-kernel-server
    state: present
    update_cache: yes

- name: Configure dnsmasq for DHCP + PXE
  copy:
    dest: /etc/dnsmasq.d/pxe.conf
    content: |
      interface=eth1
      dhcp-range=192.168.50.100,192.168.50.200,12h
      dhcp-boot=pxelinux.0
      enable-tftp
      tftp-root=/var/lib/tftpboot

- name: Create TFTP root
  file:
    path: /srv/tftp
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Copy PXE bootloader from syslinux
  copy:
    remote_src: yes
    src: /usr/lib/PXELINUX/pxelinux.0
    dest: /srv/tftp/pxelinux.0
    mode: '0755'

- name: Copy PXE kernel
  copy:
    remote_src: yes
    src: "/boot/vmlinuz-{{ ansible_kernel }}"
    dest: /srv/tftp/vmlinuz
    mode: '0644'

- name: Copy PXE initrd
  copy:
    remote_src: yes
    src: "/boot/initrd.img-{{ ansible_kernel }}"
    dest: /srv/tftp/initrd.img
    mode: '0644'

- name: Ensure dnsmasq is started
  service:
    name: dnsmasq
    state: started
    enabled: yes

# ---------------------------
# PXE Image + NFS boot setup
# ---------------------------
- name: Create NFS export directory for installation image
  file:
    path: /srv/nfs/debian-installer
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Mount Debian netboot image
  get_url:
    url: "http://deb.debian.org/debian/dists/bookworm/main/installer-amd64/current/images/netboot/netboot.tar.gz"
    dest: /tmp/netboot.tar.gz

- name: Extract netboot image to TFTP root
  unarchive:
    src: /tmp/netboot.tar.gz
    dest: /srv/tftp
    remote_src: yes

- name: Add preseed configuration for automated installs
  copy:
    src: preseed.cfg
    dest: /srv/tftp/preseed.cfg
    mode: '0644'

- name: Configure NFS exports
  copy:
    src: exports
    dest: /etc/exports
    mode: '0644'

- name: Export NFS shares
  command: exportfs -ra

- name: Restart NFS service
  service:
    name: nfs-kernel-server
    state: restarted

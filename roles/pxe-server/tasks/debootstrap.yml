---
# PXE Debian boot using debootstrap and NFS root
# Fully corrected for TFTP + NFS PXE boot

# ----------------------------
# Detect PXE interface IP
# ----------------------------
- name: Detect PXE interface IP
  shell: "ip -4 addr show dev {{ pxe_interface | default('eth1') }} | grep -oP '(?<=inet\\s)\\d+(\\.\\d+){3}'"
  register: pxe_ip
  changed_when: false
  failed_when: pxe_ip.stdout == ""

- debug:
    msg: "PXE server IP: '{{ pxe_ip.stdout }}'"

# ----------------------------
# Ensure host has internet
# ----------------------------
- name: Ensure DNS resolver is present
  lineinfile:
    path: /etc/resolv.conf
    line: "nameserver 8.8.8.8"
    state: present
    create: yes

- name: Wait until deb.debian.org is reachable
  wait_for:
    host: deb.debian.org
    port: 80
    timeout: 60

# ----------------------------
# Create directories for PXE root and TFTP
# ----------------------------
- name: Create required directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /srv/live-build/pxe-root
    - /srv/tftp
    - /srv/tftp/modules
    - /srv/tftp/pxelinux.cfg

# ----------------------------
# Bootstrap minimal Debian
# ----------------------------
- name: Bootstrap Debian base system
  command: >
    debootstrap --arch=amd64 bookworm /srv/live-build/pxe-root http://deb.debian.org/debian
  args:
    creates: /srv/live-build/pxe-root/bin/bash

# ----------------------------
# Copy resolv.conf and create sources.list
# ----------------------------
- name: Copy resolv.conf into chroot
  copy:
    src: /etc/resolv.conf
    dest: /srv/live-build/pxe-root/etc/resolv.conf

- name: Create minimal sources.list in chroot
  copy:
    dest: /srv/live-build/pxe-root/etc/apt/sources.list
    mode: '0644'
    content: |
      deb http://deb.debian.org/debian bookworm main contrib non-free
      deb http://deb.debian.org/debian bookworm-updates main contrib non-free
      deb http://security.debian.org/debian-security bookworm-security main contrib non-free
# ----------------------------
# Mount virtual filesystems (before apt)
# ----------------------------
- name: Bind /tmp inside chroot
  mount:
    path: /srv/live-build/pxe-root/tmp
    src: /tmp
    fstype: none
    opts: bind
    state: mounted

- name: Mount virtual filesystems inside chroot
  block:
    - mount: { path: /srv/live-build/pxe-root/proc, src: proc, fstype: proc, state: mounted }
    - mount: { path: /srv/live-build/pxe-root/sys, src: sysfs, fstype: sysfs, state: mounted }
    - mount: { path: /srv/live-build/pxe-root/dev, src: /dev, fstype: none, opts: bind, state: mounted }
    - mount: { path: /srv/live-build/pxe-root/dev/pts, src: /dev/pts, fstype: none, opts: bind, state: mounted }

# ----------------------------
# Update package lists inside chroot
# ----------------------------
- name: Update apt inside chroot
  command: chroot /srv/live-build/pxe-root /bin/bash -c "apt-get update"
  environment:
    PATH: "/usr/sbin:/usr/bin:/sbin:/bin"
  register: apt_update
  failed_when: apt_update.rc != 0

# ----------------------------
# Install essential packages inside chroot
# ----------------------------
- name: Install essential PXE packages inside chroot
  command: >
    chroot /srv/live-build/pxe-root /bin/bash -c "DEBIAN_FRONTEND=noninteractive apt-get install -y \
      initramfs-tools linux-image-amd64 nfs-common iproute2 net-tools sudo vim curl wget syslinux-common pxelinux"
  environment:
    PATH: "/usr/sbin:/usr/bin:/sbin:/bin"


- name: Clean apt cache inside chroot
  command: chroot /srv/live-build/pxe-root /bin/bash -c "apt-get clean"

# ----------------------------
# Create admin and standard users
# ----------------------------
- name: Ensure admin user blackpianocat exists
  command: >
    chroot /srv/live-build/pxe-root /bin/bash -c
    "id -u blackpianocat >/dev/null 2>&1 || \
     (useradd -m -s /bin/bash blackpianocat && \
      echo 'blackpianocat:sebix4ever' | chpasswd && \
      usermod -aG sudo blackpianocat)"

- name: Ensure standard users exist
  loop:
    - kotek-1
    - kotek-2
  command: >
    chroot /srv/live-build/pxe-root /bin/bash -c
    "id -u {{ item }} >/dev/null 2>&1 || useradd -m -s /bin/bash {{ item }}"

- name: Give admin passwordless sudo
  copy:
    dest: /srv/live-build/pxe-root/etc/sudoers.d/blackpianocat
    mode: '0440'
    content: |
      blackpianocat ALL=(ALL) NOPASSWD: ALL

# ----------------------------
# Add NFS support to initramfs
# ----------------------------
- name: Add NFS support to initramfs
  command: >
    chroot /srv/live-build/pxe-root /bin/bash -c
    "echo -e 'nfs\nnfsv3\nnfsv4\next4' >> /etc/initramfs-tools/modules && update-initramfs -u -k all"

# ----------------------------
# Copy PXE bootloader and kernel/initrd
# ----------------------------
- name: Find pxelinux.0
  shell: |
    for d in /usr/lib/PXELINUX /usr/lib/syslinux /usr/share/syslinux /usr/lib/syslinux/modules/bios; do
      if [ -f "$d/pxelinux.0" ]; then echo "$d/pxelinux.0"; exit 0; fi
    done
  register: pxelinux_path
  changed_when: false
  failed_when: pxelinux_path.stdout == ""

- name: Copy pxelinux.0
  copy:
    remote_src: yes
    src: "{{ pxelinux_path.stdout }}"
    dest: /srv/tftp/pxelinux.0
    mode: '0644'

# Copy core syslinux .c32 modules needed by pxelinux
- name: Copy syslinux core .c32 files to TFTP
  shell: |
    for f in /usr/lib/syslinux/*.c32 /usr/lib/PXELINUX/*.c32 /usr/lib/syslinux/modules/bios/*.c32; do
      if [ -f "$f" ]; then cp "$f" /srv/tftp/; fi
    done
  args:
    executable: /bin/bash

- name: Copy kernel and initrd images to TFTP
  shell: |
    cp /srv/live-build/pxe-root/boot/vmlinuz-* /srv/tftp/vmlinuz
    cp /srv/live-build/pxe-root/boot/initrd.img-* /srv/tftp/initrd.img
  args:
    executable: /bin/bash

- name: Set permissions for TFTP files
  file:
    path: "{{ item }}"
    mode: '0644'
  loop:
    - /srv/tftp/vmlinuz
    - /srv/tftp/initrd.img
    - /srv/tftp/pxelinux.0

# ----------------------------
# Configure PXE menu
# ----------------------------
- name: Configure PXE menu for NFS root
  copy:
    dest: /srv/tftp/pxelinux.cfg/default
    mode: '0644'
    content: |
      DEFAULT debian
      PROMPT 0
      TIMEOUT 50

      LABEL debian
        MENU LABEL Boot Debian PXE
        KERNEL vmlinuz
        INITRD initrd.img
        APPEND root=/dev/nfs nfsroot={{ pxe_ip.stdout }}:/srv/live-build/pxe-root,rw ip=dhcp nfsrootwait

# ----------------------------
# Export NFS root
# ----------------------------
- name: Ensure /etc/exports.d exists
  file:
    path: /etc/exports.d
    state: directory
    mode: '0755'

- name: Configure NFS export
  copy:
    dest: /etc/exports.d/pxe-root.exports
    mode: '0644'
    content: "/srv/live-build/pxe-root {{ pxe_ip.stdout }}/24(rw,no_root_squash,no_subtree_check)"

- name: Reload NFS exports
  command: exportfs -ra

- name: Ensure NFS server is running
  service:
    name: nfs-kernel-server
    state: started
    enabled: yes

# ----------------------------
# Cleanup: unmount chroot filesystems
# ----------------------------
- name: Unmount virtual filesystems
  block:
    - shell: umount /srv/live-build/pxe-root/dev/pts || true
    - shell: umount /srv/live-build/pxe-root/dev || true
    - shell: umount /srv/live-build/pxe-root/sys || true
    - shell: umount /srv/live-build/pxe-root/proc || true
  ignore_errors: yes

- name: PXE boot image ready
  debug:
    msg: "PXE root is bootable. Clients can now boot via network."


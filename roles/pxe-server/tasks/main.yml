---
# ===========================
# PXE + Clonezilla Server Setup (Debian)
# ===========================

# ----------------------------
# Detect PXE interface (host-only adapter)
# ----------------------------
- name: Detect PXE interface (host-only adapter)
  shell: ip -o -4 addr show | awk '/192\.168\.56\./ {print $2; exit}'
  register: iface_result
  changed_when: false
  failed_when: iface_result.rc != 0 or iface_result.stdout == ""

- name: Set PXE interface fact
  set_fact:
    pxe_interface: "{{ iface_result.stdout | trim | default('eth1') }}"

- name: Detect PXE interface IP
  shell: ip -4 addr show {{ pxe_interface }} | awk '/inet / {gsub("/.*","",$2); print $2}'
  register: pxe_ip
  changed_when: false
  failed_when: pxe_ip.rc != 0 or pxe_ip.stdout == ""

- name: Show PXE interface info
  debug:
    msg: "Using interface {{ pxe_interface }} with IP {{ pxe_ip.stdout }}"

# ----------------------------
# Install packages
# ----------------------------
- name: Install PXE, NFS, and Clonezilla dependencies
  apt:
    name:
      - dnsmasq
      - pxelinux
      - syslinux-common
      - nfs-kernel-server
      - unzip
      - net-tools
      - tftp
    state: present
    update_cache: yes

# ----------------------------
# Setup TFTP root
# ----------------------------
- name: Create TFTP directory
  file:
    path: /srv/tftp
    state: directory
    owner: nobody
    group: nogroup
    mode: '0755'

# ----------------------------
# PXELINUX bootloader
# ----------------------------
- name: Find pxelinux.0 in system
  shell: |
    for d in /usr/lib/PXELINUX /usr/lib/syslinux /usr/share/syslinux /usr/lib/syslinux/modules/bios; do
      if [ -f "$d/pxelinux.0" ]; then echo "$d/pxelinux.0"; exit 0; fi
    done
  register: pxelinux_path
  failed_when: pxelinux_path.rc != 0 or pxelinux_path.stdout == ""
  changed_when: false

- name: Copy PXE bootloader
  copy:
    remote_src: yes
    src: "{{ pxelinux_path.stdout }}"
    dest: /srv/tftp/pxelinux.0
    mode: '0644'

# ----------------------------
# Copy syslinux BIOS modules
# ----------------------------
- name: Copy syslinux BIOS modules to TFTP
  shell: |
    mkdir -p /srv/tftp/modules
    for d in /usr/lib/syslinux/modules/bios /usr/share/syslinux; do
      if [ -d "$d" ]; then cp -a $d/* /srv/tftp/modules/; fi
    done

# ----------------------------
# Download Debian Live ISO (XFCE)
# ----------------------------
- name: Download Debian Live XFCE ISO
  get_url:
    url: "https://cdimage.debian.org/debian-cd/current-live/amd64/iso-hybrid/debian-live-13.1.0-amd64-xfce.iso"
    dest: /tmp/debian-live-xfce.iso
    mode: '0644'
  when: not ("/tmp/debian-live-xfce.iso" is file)

# ----------------------------
# Mount and copy Debian Live contents
# ----------------------------
- name: Mount Debian Live ISO
  mount:
    path: /mnt/debian-live
    src: /tmp/debian-live-xfce.iso
    fstype: iso9660
    state: mounted

- name: Copy live files to TFTP directory
  shell: |
    mkdir -p /srv/tftp/debian-live
    cp -r /mnt/debian-live/live /srv/tftp/debian-live/
    cp -r /mnt/debian-live/isolinux/* /srv/tftp/debian-live/
  args:
    executable: /bin/bash

- name: Unmount Debian Live ISO
  mount:
    path: /mnt/debian-live
    state: unmounted

# ----------------------------
# Download and unpack Clonezilla Live
# ----------------------------
- name: Download Clonezilla Live ZIP (if not present)
  get_url:
    url: "https://netcologne.dl.sourceforge.net/project/clonezilla/clonezilla_live_stable/3.2.2-15/clonezilla-live-3.2.2-15-amd64.zip"
    dest: /tmp/clonezilla-live.zip
    mode: '0644'
  when: not ("/tmp/clonezilla-live.zip" is file)

- name: Extract Clonezilla Live
  unarchive:
    src: /tmp/clonezilla-live.zip
    dest: /srv/tftp/
    remote_src: yes

# ----------------------------
# Fix permissions for TFTP
# ----------------------------
- name: Ensure TFTP folder permissions
  file:
    path: /srv/tftp
    recurse: yes
    owner: nobody
    group: nogroup
    mode: '0755'

# ----------------------------
# PXE boot menu configuration
# ----------------------------
- name: Create PXE default menu for Debian Live XFCE
  copy:
    dest: /srv/tftp/pxelinux.cfg/default
    content: |
      DEFAULT debianlive
      PROMPT 0
      TIMEOUT 50
      MENU TITLE PXE Boot Menu

      LABEL debianlive
        MENU LABEL Debian Live 13.1.0 XFCE
        KERNEL debian-live/live/vmlinuz
        APPEND initrd=debian-live/live/initrd.img boot=live components fetch=tftp://{{ pxe_ip.stdout }}/debian-live/live/filesystem.squashfs

    
# ----------------------------
# Configure dnsmasq (DHCP + PXE)
# ----------------------------
- name: Backup original dnsmasq config
  copy:
    src: /etc/dnsmasq.conf
    dest: /etc/dnsmasq.conf.bak
    remote_src: yes
    force: no

- name: Remove old PXE configs
  file:
    path: /etc/dnsmasq.d/pxe.conf
    state: absent

- name: Configure dnsmasq for PXE
  copy:
    dest: /etc/dnsmasq.d/pxe.conf
    content: |
      interface={{ pxe_interface }}
      bind-interfaces
      dhcp-range=192.168.56.100,192.168.56.200,12h
      dhcp-boot=pxelinux.0
      enable-tftp
      tftp-root=/srv/tftp
      log-dhcp

# ----------------------------
# Service management
# ----------------------------
- name: Restart dnsmasq safely
  systemd:
    name: dnsmasq
    state: restarted
    enabled: yes

- name: Wait for dnsmasq process to be active (TFTP readiness)
  shell: pgrep -x dnsmasq
  register: dnsmasq_pid
  retries: 5
  delay: 5
  until: dnsmasq_pid.rc == 0
  changed_when: false

# -----------------------------------
# Deploy Debian Live ISO for PXE boot
# -----------------------------------
- name: Create directories for Debian Live ISO
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /srv/iso
    - /srv/tftp/debian-live
    - /mnt/debian

- name: Download Debian Live ISO
  get_url:
    url: "https://cdimage.debian.org/debian-cd/current-live/amd64/iso-hybrid/debian-live-13.1.0-amd64-xfce.iso"
    dest: "/srv/iso/debian-live-13.1.0-amd64-xfce.iso"
    mode: '0644'
  register: debian_iso

- name: Mount Debian ISO
  mount:
    path: /mnt/debian
    src: /srv/iso/debian-live-13.1.0-amd64-xfce.iso
    fstype: iso9660
    state: mounted

- name: Copy Debian Live boot files (vmlinuz, initrd, etc.)
  copy:
    src: "{{ item }}"
    dest: /srv/tftp/debian-live/
    remote_src: yes
  with_items:
    - /mnt/debian/live
    - /mnt/debian/isolinux
  ignore_errors: yes

- name: Unmount Debian ISO
  mount:
    path: /mnt/debian
    state: unmounted

# -----------------------------------
# Configure nginx to serve Debian files (faster than TFTP)
# -----------------------------------
- name: Install nginx for HTTP boot
  apt:
    name: nginx
    state: present
    update_cache: yes

- name: Symlink Debian Live directory to nginx web root
  file:
    src: /srv/tftp/debian-live
    dest: /var/www/html/debian-live
    state: link
    force: yes

- name: Ensure nginx is running
  systemd:
    name: nginx
    state: started
    enabled: yes

# -----------------------------------
# Update PXE boot menu
# -----------------------------------
- name: Add Debian Live entry to PXE menu
  blockinfile:
    path: /srv/tftp/pxelinux.cfg/default
    marker: "# {mark} DEBIAN-LIVE"
    block: |
      LABEL Debian Live XFCE
          MENU LABEL Debian Live 13.1.0 XFCE (64-bit)
          KERNEL debian-live/live/vmlinuz
          APPEND initrd=debian-live/live/initrd.img boot=live components fetch=http://{{ ansible_default_ipv4.address }}/debian-live/live/filesystem.squashfs


# roles/pxe-server/tasks/users.yml

- name: Create users with no password
  ansible.builtin.command: >
    chroot {{ chroot_path }} useradd -m -s /bin/bash blackpianocat

- name: Create whitesexyorca user
  ansible.builtin.command: >
    chroot {{ chroot_path }} useradd -m -s /bin/bash whitesexyorca

- name: Create users with predefined passwords
  vars:
    users_passwords:
      - { name: "whitesmellyracoon", password: "racoonsfart" }
      - { name: "admin", password: "admin_rocks" }
  loop: "{{ users_passwords }}"
  loop_control:
    loop_var: user
  ansible.builtin.command: >
    chroot {{ chroot_path }} bash -c
    "useradd -m -s /bin/bash {{ user.name }} &&
     echo '{{ user.name }}:{{ user.password }}' | chpasswd"

- name: Create user redhandsomegorilla forcing password change
  ansible.builtin.command: >
    chroot {{ chroot_path }} bash -c
    "useradd -m -s /bin/bash redhandsomegorilla &&
     passwd -d redhandsomegorilla &&
     chage -d 0 redhandsomegorilla"

- name: Give admin full sudo
  ansible.builtin.copy:
    dest: "{{ chroot_path }}/etc/sudoers.d/admin"
    mode: "0440"
    content: |
      admin ALL=(ALL) ALL

- name: Give blackpianocat passwordless sudo
  ansible.builtin.copy:
    dest: "{{ chroot_path }}/etc/sudoers.d/blackpianocat"
    mode: "0440"
    content: |
      blackpianocat ALL=(ALL) NOPASSWD: ALL


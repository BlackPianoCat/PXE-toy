---
# PXE server role for Vagrant NFS/PXE boot

# ----------------------------
# PXE interface
# ----------------------------
- name: Set PXE interface fact
  set_fact:
    # Vagrant host only adapter is eth1 inside the VM
    pxe_interface: "eth1"

- name: Get PXE server IP
  shell: ip -4 addr show {{ pxe_interface }} | awk '/inet / {gsub("/.*","",$2); print $2}'
  register: pxe_ip
  changed_when: false

- debug:
    msg: "PXE interface={{ pxe_interface }}, IP={{ pxe_ip.stdout }}"

# ----------------------------
# Ensure PXE/NFS packages installed
# ----------------------------
- name: Install PXE/NFS packages
  apt:
    name:
      - dnsmasq
      - pxelinux
      - syslinux-common
      - nfs-kernel-server
      - tftp
      - unzip
      - net-tools
    state: present
    update_cache: yes

# ----------------------------
# Prepare TFTP directories
# ----------------------------
- name: Ensure TFTP directories
  file:
    path: "{{ item }}"
    state: directory
    owner: nobody
    group: nogroup
    mode: '0755'
  loop:
    - /srv/tftp
    - /srv/tftp/pxelinux.cfg

# ----------------------------
# Copy PXELINUX binaries
# ----------------------------
- name: Find pxelinux.0
  shell: |
    for d in /usr/lib/PXELINUX /usr/lib/syslinux /usr/share/syslinux /usr/lib/syslinux/modules/bios; do
      [ -f "$d/pxelinux.0" ] && echo "$d/pxelinux.0" && exit 0
    done
  register: pxelinux_path
  changed_when: false
  failed_when: pxelinux_path.stdout == ""

- name: Copy pxelinux.0
  copy:
    remote_src: yes
    src: "{{ pxelinux_path.stdout }}"
    dest: /srv/tftp/pxelinux.0
    mode: '0644'

- name: Copy .c32 modules
  shell: |
    for dir in /usr/lib/syslinux /usr/lib/PXELINUX /usr/lib/syslinux/modules/bios /usr/lib/x86_64-linux-gnu/syslinux; do
      [ -d "$dir" ] || continue
      cp -f "$dir"/*.c32 /srv/tftp/ 2>/dev/null || true
    done
  args:
    executable: /bin/bash

# ----------------------------
# Copy kernel/initrd
# ----------------------------
- name: Copy vmlinuz and initrd.img
  shell: |
    vmlinuz=$(ls -1t /srv/debian-root/boot/vmlinuz-* | head -n1)
    initrd=$(ls -1t /srv/debian-root/boot/initrd.img-* | head -n1)
    cp -f "$vmlinuz" /srv/tftp/vmlinuz
    cp -f "$initrd" /srv/tftp/initrd.img
  args:
    executable: /bin/bash

# ----------------------------
# PXE menu
# ----------------------------
- name: Create PXE boot menu
  copy:
    dest: /srv/tftp/pxelinux.cfg/default
    mode: '0644'
    content: |
      DEFAULT debian
      PROMPT 0
      TIMEOUT 20

      LABEL debian
        MENU LABEL Debian PXE (NFS root)
        KERNEL vmlinuz
        INITRD initrd.img
        APPEND root=/dev/nfs ip=dhcp \
          nfsroot={{ pxe_ip.stdout }}:/srv/debian-root,vers=3,rw,nolock \
          nfsrootdebug

# ----------------------------
# NFS export
# ----------------------------
- name: Ensure PXE root exists
  file:
    path: /srv/debian-root
    state: directory
    owner: nobody
    group: nogroup
    mode: '0755'

- name: Create /etc/exports for PXE root
  copy:
    dest: /etc/exports
    mode: '0644'
    content: |
      /srv/debian-root 192.168.56.0/24(rw,async,no_root_squash,no_subtree_check)

- name: Reload NFS exports
  command: exportfs -ra

- name: Start nfs-kernel-server
  service:
    name: nfs-kernel-server
    state: started
    enabled: yes

# ----------------------------
# dnsmasq
# ----------------------------
# gather current services first
- name: Gather service facts
  service_facts:

# stop systemd-resolved if it exists
- name: Stop systemd-resolved if running
  systemd:
    name: systemd-resolved
    state: stopped
    enabled: no
  when: "'systemd-resolved' in ansible_facts.services"
  ignore_errors: yes

- name: Replace resolv.conf with public DNS
  copy:
    dest: /etc/resolv.conf
    content: "nameserver 8.8.8.8\n"
    owner: root
    group: root
    mode: '0644'

- name: Configure dnsmasq for PXE
  copy:
    dest: /etc/dnsmasq.d/pxe.conf
    mode: '0644'
    content: |
      interface={{ pxe_interface }}
      bind-interfaces
      dhcp-range=192.168.56.100,192.168.56.200,12h
      dhcp-boot=pxelinux.0
      enable-tftp
      tftp-root=/srv/tftp
      log-dhcp

- name: Test dnsmasq configuration
  shell: dnsmasq --test
  register: dnsmasq_test
  ignore_errors: yes
  changed_when: false

- name: Debug dnsmasq test output
  debug:
    var: dnsmasq_test.stdout_lines

- name: Restart dnsmasq if configuration is valid
  systemd:
    name: dnsmasq
    state: restarted
    enabled: yes
  when: dnsmasq_test.rc == 0

- name: Warn if dnsmasq configuration is invalid
  debug:
    msg: "dnsmasq configuration failed. Check pxe.conf."
  when: dnsmasq_test.rc != 0


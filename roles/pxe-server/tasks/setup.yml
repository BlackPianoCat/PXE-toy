---
# ===========================
# PXE + NFS-root Debian boot (no Debian Live)
# ===========================

# ----------------------------
# Detect PXE interface
# ----------------------------
- name: Detect PXE interface (host-only adapter)
  shell: ip -o -4 addr show | awk '/192\.168\.56\./ {print $2; exit}'
  register: iface_result
  changed_when: false
  failed_when: iface_result.rc != 0 or iface_result.stdout == ""

- name: Set PXE interface fact
  set_fact:
    pxe_interface: "{{ iface_result.stdout | trim }}"

- name: Detect PXE interface IP
  shell: ip -4 addr show {{ pxe_interface }} | awk '/inet / {gsub("/.*","",$2); print $2}'
  register: pxe_ip
  changed_when: false

# ----------------------------
# Install PXE and NFS packages
# ----------------------------
- name: Install PXE, NFS, and Clonezilla dependencies
  apt:
    name:
      - dnsmasq
      - pxelinux
      - syslinux-common
      - nfs-kernel-server
      - unzip
      - net-tools
      - tftp
    state: present
    update_cache: yes

# ----------------------------
# Prepare TFTP root
# ----------------------------
- name: Create TFTP directory
  file:
    path: /srv/tftp
    state: directory
    owner: nobody
    group: nogroup
    mode: '0755'

# ----------------------------
# Copy PXE bootloader
# ----------------------------
- name: Find pxelinux.0 in system
  shell: |
    for d in /usr/lib/PXELINUX /usr/lib/syslinux /usr/share/syslinux /usr/lib/syslinux/modules/bios; do
      if [ -f "$d/pxelinux.0" ]; then echo "$d/pxelinux.0"; exit 0; fi
    done
  register: pxelinux_path
  changed_when: false

- name: Copy pxelinux.0
  copy:
    remote_src: yes
    src: "{{ pxelinux_path.stdout }}"
    dest: /srv/tftp/pxelinux.0
    mode: '0644'

# ----------------------------
# Copy syslinux BIOS modules
# ----------------------------
- name: Copy syslinux BIOS modules to TFTP
  shell: |
    mkdir -p /srv/tftp/modules
    for d in /usr/lib/syslinux/modules/bios /usr/share/syslinux; do
      if [ -d "$d" ]; then cp -a $d/* /srv/tftp/modules/; fi
    done

# ----------------------------
# Download Debian Live XFCE ISO (for bootstrap use only)
# ----------------------------
- name: Create directories for Debian Live ISO
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /srv/iso
    - /mnt/debian

- name: Download Debian Live XFCE ISO
  get_url:
    url: "https://cdimage.debian.org/cdimage/weekly-live-builds/amd64/iso-hybrid/debian-live-testing-amd64-xfce.iso"
    dest: "/srv/iso/debian-live-amd64-xfce.iso"
    mode: '0644'
    force: no
  register: debian_iso

# (Not mounted, not used for booting. Only available if you want to extract pool packages later.)

# ----------------------------
# Download Clonezilla Live ZIP using aria2c (fast and resumable)
# ----------------------------
- name: Ensure aria2c is installed
  apt:
    name: aria2
    state: present
    update_cache: yes

- name: Download Clonezilla Live ZIP with aria2c if not present
  shell: |
    if [ ! -f /tmp/clonezilla-live.zip ]; then
      aria2c -x 16 -s 16 -k 1M -o /tmp/clonezilla-live.zip https://netcologne.dl.sourceforge.net/project/clonezilla/clonezilla_live_stable/3.2.2-15/clonezilla-live-3.2.2-15-amd64.zip
    fi
  args:
    executable: /bin/bash
  changed_when: false

- name: Extract Clonezilla
  unarchive:
    src: /tmp/clonezilla-live.zip
    dest: /srv/tftp/
    remote_src: yes
    creates: /srv/tftp/clonezilla-live-3.2.2-15-amd64

# ----------------------------
# Create PXE config directory
# ----------------------------
- name: Create pxelinux.cfg directory
  file:
    path: /srv/tftp/pxelinux.cfg
    state: directory
    mode: '0755'

# ----------------------------
# Create PXE default menu (empty for now)
# It will be filled by debootstrap.yml
# ----------------------------
- name: Create minimal PXE menu (placeholder)
  copy:
    dest: /srv/tftp/pxelinux.cfg/default
    mode: '0644'
    content: |
      DEFAULT local
      LABEL local
        LOCALBOOT 0

# ----------------------------
# Configure dnsmasq (DHCP + PXE)
# ----------------------------
- name: Backup dnsmasq.conf
  copy:
    src: /etc/dnsmasq.conf
    dest: /etc/dnsmasq.conf.bak
    remote_src: yes
    force: no

- name: Configure dnsmasq for PXE
  copy:
    dest: /etc/dnsmasq.d/pxe.conf
    content: |
      interface={{ pxe_interface }}
      bind-interfaces
      dhcp-range=192.168.56.100,192.168.56.200,12h
      dhcp-boot=pxelinux.0
      enable-tftp
      tftp-root=/srv/tftp
      log-dhcp

# ----------------------------
# Restart dnsmasq
# ----------------------------
- name: Restart dnsmasq
  systemd:
    name: dnsmasq
    state: restarted
    enabled: yes


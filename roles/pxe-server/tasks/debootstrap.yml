---
# PXE NFS boot root creation using debootstrap

# -------------------------------------------------
# Host networking
# -------------------------------------------------
- name: Ensure host can resolve names
  lineinfile:
    path: /etc/resolv.conf
    line: "nameserver 8.8.8.8"
    state: present
    create: yes

- name: Wait for Debian mirror
  wait_for:
    host: deb.debian.org
    port: 80
    timeout: 60

# -------------------------------------------------
# Build root
# -------------------------------------------------
- name: Create NFS PXE build root
  file:
    path: /srv/live-build/pxe-root
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Bootstrap Debian base system
  command: >
    debootstrap --arch=amd64 bookworm /srv/live-build/pxe-root http://deb.debian.org/debian
  args:
    creates: /srv/live-build/pxe-root/bin/bash

# -------------------------------------------------
# Configure apt inside build root
# -------------------------------------------------
- name: Copy resolv.conf into build root
  copy:
    src: /etc/resolv.conf
    dest: /srv/live-build/pxe-root/etc/resolv.conf
    mode: '0644'

- name: Create sources.list in build root
  copy:
    dest: /srv/live-build/pxe-root/etc/apt/sources.list
    mode: '0644'
    content: |
      deb http://deb.debian.org/debian bookworm main contrib non-free
      deb http://deb.debian.org/debian bookworm-updates main contrib non-free
      deb http://security.debian.org/debian-security bookworm-security main contrib non-free

# -------------------------------------------------
# Mount virtual filesystems
# -------------------------------------------------
- name: Mount chroot virtual filesystems
  block:
    - mount: { path: /srv/live-build/pxe-root/proc, src: proc, fstype: proc, state: mounted }
    - mount: { path: /srv/live-build/pxe-root/sys, src: sysfs, fstype: sysfs, state: mounted }
    - mount: { path: /srv/live-build/pxe-root/dev, src: /dev, fstype: none, opts: bind, state: mounted }
    - mount: { path: /srv/live-build/pxe-root/dev/pts, src: /dev/pts, fstype: none, opts: bind, state: mounted }
    - mount: { path: /srv/live-build/pxe-root/run, src: /run, fstype: none, opts: bind, state: mounted }
    - mount: { path: /srv/live-build/pxe-root/tmp, src: tmpfs, fstype: tmpfs, opts: mode=1777, state: mounted }

# -------------------------------------------------
# Install essential packages inside build root
# -------------------------------------------------
- name: Update apt inside build root
  command: chroot /srv/live-build/pxe-root /bin/bash -c "apt-get update"

- name: Install essential packages inside build root
  command: >
    chroot /srv/live-build/pxe-root /bin/bash -c
    "DEBIAN_FRONTEND=noninteractive apt-get install -y \
     initramfs-tools linux-image-amd64 nfs-common iproute2 net-tools sudo vim curl wget libc-bin"

- name: Clean apt inside build root
  command: chroot /srv/live-build/pxe-root /bin/bash -c "apt-get clean"
  changed_when: false

# -------------------------------------------------
# Users, hostname, hosts
# -------------------------------------------------
- name: Ensure admin user exists
  command: >
    chroot /srv/live-build/pxe-root /bin/bash -c
    "id -u blackpianocat >/dev/null 2>&1 ||
     (useradd -m -s /bin/bash blackpianocat &&
      echo 'blackpianocat:sebix4ever' | chpasswd &&
      usermod -aG sudo blackpianocat)"
  changed_when: false

- name: Set hostname
  copy:
    dest: /srv/live-build/pxe-root/etc/hostname
    content: "pxeclient\n"

- name: Create hosts
  copy:
    dest: /srv/live-build/pxe-root/etc/hosts
    content: |
      127.0.0.1 localhost
      127.0.1.1 pxeclient

# -------------------------------------------------
# Minimal device nodes in build root
# -------------------------------------------------
- name: Create essential device nodes in build root
  block:
    - file: { path: /srv/live-build/pxe-root/dev, state: directory, mode: '0755' }
    - command: mknod -m 666 /srv/live-build/pxe-root/dev/null c 1 3
      args: { creates: /srv/live-build/pxe-root/dev/null }
    - command: mknod -m 666 /srv/live-build/pxe-root/dev/zero c 1 5
      args: { creates: /srv/live-build/pxe-root/dev/zero }
    - command: mknod -m 600 /srv/live-build/pxe-root/dev/console c 5 1
      args: { creates: /srv/live-build/pxe-root/dev/console }

# -------------------------------------------------
# Build initramfs in build root
# -------------------------------------------------
- name: Update initramfs in build root
  command: chroot /srv/live-build/pxe-root /bin/bash -c "update-initramfs -u -k all"

# -------------------------------------------------
# Unmount virtual filesystems
# -------------------------------------------------
- name: Unmount chroot virtual filesystems
  block:
    - command: umount -l /srv/live-build/pxe-root/run
      ignore_errors: yes
    - command: umount -l /srv/live-build/pxe-root/dev/pts
      ignore_errors: yes
    - command: umount -l /srv/live-build/pxe-root/dev
      ignore_errors: yes
    - command: umount -l /srv/live-build/pxe-root/sys
      ignore_errors: yes
    - command: umount -l /srv/live-build/pxe-root/proc
      ignore_errors: yes
    - command: umount -l /srv/live-build/pxe-root/tmp
      ignore_errors: yes

# -------------------------------------------------
# Copy build root to final NFS root
# -------------------------------------------------
- name: Ensure final PXE root exists
  file:
    path: /srv/debian-root
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Copy completed build root to final NFS root
  shell: >
    rsync -a --one-file-system
    --exclude=/proc --exclude=/sys --exclude=/dev --exclude=/dev/pts
    --exclude=/run --exclude=/tmp
    /srv/live-build/pxe-root/ /srv/debian-root/

# -------------------------------------------------
# Prepare final root for NFS boot
# -------------------------------------------------
- name: Ensure /dev and /tmp exist in final root
  file:
    path: "{{ item.path }}"
    state: directory
    mode: "{{ item.mode }}"
  loop:
    - { path: /srv/debian-root/dev, mode: '0755' }
    - { path: /srv/debian-root/tmp, mode: '1777' }

- name: Create minimal device nodes in final root
  block:
    - command: mknod -m 666 /srv/debian-root/dev/null c 1 3
      args: { creates: /srv/debian-root/dev/null }
    - command: mknod -m 666 /srv/debian-root/dev/zero c 1 5
      args: { creates: /srv/debian-root/dev/zero }
    - command: mknod -m 600 /srv/debian-root/dev/console c 5 1
      args: { creates: /srv/debian-root/dev/console }

- name: Ensure essential packages in final root
  command: >
    chroot /srv/debian-root /bin/bash -c
    "DEBIAN_FRONTEND=noninteractive apt-get install -y initramfs-tools nfs-common libc-bin"

- name: Rebuild final initramfs
  command: chroot /srv/debian-root /bin/bash -c "update-initramfs -u -k all"

# -------------------------------------------------
# Fix final root permissions
# -------------------------------------------------
- name: Fix safe directories permissions
  file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: "0755"
  loop:
    - /srv/debian-root/bin
    - /srv/debian-root/etc
    - /srv/debian-root/usr
    - /srv/debian-root/lib
    - /srv/debian-root/sbin

